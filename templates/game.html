<!DOCTYPE html>
<html>
    <head>
        <title>Kámen, nůžky, papír</title>
        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
        <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
    </head>
    <body>
        <a id="back_button" href="/">Zpět</a>
        <div>
            <h1>Kámen, nůžky, papír</h1>
            <p>Pomocí počítačového vidění</p>
            <video autoplay></video>
        </div>
        <div id="status_screen">
            <p id="players">Neznámé vs Neznámé</p>
            <p id="game_status">Načítání...</p>
            <p id="gesture_image">❓</p>
            <p id="gesture_name">Hrajete: Neznámé</p>
        </div>
    </body>
</html>

<style>
    body {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    h1 {
        font-weight: 700;
        font-size: 64px;
        color: rgba(255, 255, 255, 1);
    }

    p {
        margin-top: -20px;
        font-weight: 400;
        font-size: 32px;
        color: rgba(255, 255, 255, 0.9);
    }

    video {
        width: 50vw;
        margin-bottom: 5vh;
        height: calc(50vw * 0.5);
        background: black;
        border-radius: 10px;
    }

    #status_screen {
        margin-top: 22vh;
        margin-left: 7.5vw;
        width: 20vw;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #players {
        font-weight: 700;
        font-size: 32px;
        color: rgba(255, 255, 255, 1);
    }

    #game_status {
        margin-top: -20px;
        font-weight: 400;
        font-size: 24px;
        color: rgba(255, 255, 255, 0.9);
    }

    #gesture_image {
        font-size: 256px;
        color: rgba(255, 255, 255, 1);
    }

    #gesture_name {
        margin-top: -256px;
        font-size: 26px;
        color: rgba(255, 255, 255, 1);
    }

    @media only screen and (max-device-width: 480px) {
        body {
            flex-direction: column;
        }

        h1 {
            font-size: 72px;
        }

        p {
            font-size: 46px;
        }

        video {
            width: 80vw;
            height: calc(80vw * 0.6);
        }

        #status_screen {
            width: 80vw;
            margin-top: 0vh;
            margin-left: 0vw;
        }

        #players {
            font-size: 56px;
        }

        #game_status {
            font-size: 42px;
        }

        #gesture_image {
            margin-top: 20px;
        }

        #gesture_name {
            font-size: 48px;
            margin-top: -200px;
        }
    }
</style>

<script type="text/javascript">
    const socket = io.connect('wss://' + document.domain + ':' + location.port);
    const urlParams = new URLSearchParams(window.location.search);

    socket.on('response', function(data) {
        document.getElementById('players').innerText = `${urlParams.get('name')} vs ${data.opponent}`;
        document.getElementById('game_status').innerText = data.status;
        document.getElementById('gesture_image').innerText = data.gesture_image;
        document.getElementById('gesture_name').innerText = `Hrajete: ${data.gesture_name}`;
    });

    function captureAndSendImage() {
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        socket.emit('image', canvas.toDataURL('image/jpeg'));
    }

    function startCamera() {
        navigator.mediaDevices.enumerateDevices()
            .then(function(devices) {
                videoDevices = devices.filter(function(device) {
                    return device.kind === 'videoinput';
                });

                if (videoDevices.length <= 0){
                    throw new Error('Žádná kamera nenalezena.');
                }
                
                if (urlParams.has('camera')){
                    const cameraIDParam = urlParams.get('camera');
                    const cameraID = Number(cameraIDParam);

                    var chosenCamera = videoDevices[cameraID];
                    return navigator.mediaDevices.getUserMedia({ video: { deviceId: chosenCamera.deviceId } });
                }
                else {
                    const name = urlParams.get("name");
                    if (videoDevices.length > 1){
                        location.href = `/pick-camera-device?name=${name}`;
                    }
                    else {
                        location.href = `/game?name=${name}&camera=0`;
                    }
                }
            })
            .then(function(stream) {
                const video = document.querySelector('video');
                video.srcObject = stream;
                video.onloadedmetadata = function(e) {
                    video.play();
                    setInterval(captureAndSendImage, 250); // Snímek každých 250 ms
                };
            })
            .catch(function(err) {
                console.log(err);
            });
    }

    window.addEventListener("load", (event) => {
        startCamera();
    });
</script>